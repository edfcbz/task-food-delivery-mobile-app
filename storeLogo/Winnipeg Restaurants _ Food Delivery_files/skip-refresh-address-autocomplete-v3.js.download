window.skipthedishes=window.skipthedishes||{},window.skipthedishes.AddressAutocompleteV3=function($,skipLoading,skipAlerts,skipLogging,navDropdowns,googleMap,commonTools,geoService){function _showErrorMessage(message){_$addressMapAddNew.is(":hidden")?skipAlerts.showTopAlert(WARNING,message):_showAddressError(message)}function _showAddressError(message){_$addressErrorBlock&&(_$addressErrorBlock.removeClass("hidden"),_$addressErrorBlock.html(message)),_$addressSubmitBtn&&_$addressSubmitBtn.addClass("hidden"),navDropdowns.updateDropdownMenuHeight()}function _hideAddressError(){skipAlerts.clearTopAlerts(),_$addressErrorBlock&&_$addressErrorBlock.addClass("hidden"),_$addressSubmitBtn&&_$addressSubmitBtn.removeClass("hidden"),navDropdowns.updateDropdownMenuHeight()}function _highlightAddress(hasError){_$addressAutocomplete&&_$addressAutocomplete.closest(".form-group").toggleClass("has-error",hasError),_$userAddressesSelect&&_$userAddressesSelect.closest(".form-group").toggleClass("has-error",hasError)}function _setDisableReverseGeocodingArea(address){_disableReverseGeocodingRadius=DISABLE_REVERSE_GEOCODING_RADIUS_SPECIFIC_BUILDING,address.accuracy==UNSURE&&(_disableReverseGeocodingRadius=DISABLE_REVERSE_GEOCODING_RADIUS_RANGE_OF_BUILDINGS)}function _validateAddress(addressObject){return addressObject.accuracy!=INACCURATE||_allowAllAddresses?(_hideAddressError(),!0):(_showErrorMessage("Provide a single house or building number."),skipLoading.showLoading(!1),!1)}function _loadGoogleMaps(){if(!_googleMapsIsAvailable&&!_currentlyLoadingGoogleMaps){_currentlyLoadingGoogleMaps=!0;var mapParams={callbackFunctionName:"window.skipthedishes.AddressAutocompleteV3.handleGoogleMapsInit"};googleMap.loadGoogleMaps(mapParams)}}function _setCorrectedCoordinates(latLng){_addressLatitudeCorrected=latLng.lat(),_addressLongitudeCorrected=latLng.lng()}function _clearCorrectedCoordinates(){_addressLatitudeCorrected=null,_addressLongitudeCorrected=null}function _resetAddressSelectWidgetToInitialAddress(){_newAddress=null,clearTimeout(_geocoderRequestTimeout),_clearCorrectedCoordinates(),_$addressResetBtn.addClass("hidden"),_$addressDraggableBtn.removeClass("hidden"),_addressMap&&(_addressMap.set("draggable",!1),_addressMap.set("scrollwheel",!1),_addressMap.set("disableDoubleClickZoom",!0),_addressMap.set("zoom",_googleMapsZoom),_addressMap.set("keyboardShortcuts",!1))}function _startTimerForChangeAddressAccordingToNewPinPosition(){var mapCenter=_addressMap.getCenter();_latitudeLongitudeForMap=mapCenter,clearTimeout(_geocoderRequestTimeout),_geocoderRequestTimeout=setTimeout(_changeAddressAccordingToNewPinPosition,1e3)}function _changeAddressAccordingToNewPinPosition(){var mapCenter=_addressMap.getCenter(),area=new window.google.maps.Circle({center:_latitudeLongitude,radius:_disableReverseGeocodingRadius});if(!_latitudeLongitude.equals(mapCenter))if(area.getBounds().contains(mapCenter)&&!_newAddress){var addressObject=_loadAddressObjectFromForm();_setCorrectedCoordinates(mapCenter),_validateAddress(addressObject)}else{var _geocoder=_geocoder||new window.google.maps.Geocoder;_geocoder.geocode({location:mapCenter},function(results,status){if(status===OK)if(results[0]){_clearCorrectedCoordinates(),_newAddress=results[0],_$addressAutocomplete.val(_newAddress.formatted_address);var addressObject=_populateAddressObject(_newAddress,_newAddress.formatted_address);_validateAddress(addressObject)}else _showErrorMessage(NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_PIN),skipLoading.showLoading(!1);else _showErrorMessage(NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_PIN),skipLoading.showLoading(!1),skipLogging.error("_changeAddressAccordingToNewPinPosition: Google geocoder failed due to: "+status+" location: "+mapCenter)})}}function _generateStaticMap(params){var markers=params&&params.markers?params.markers:[],staticMapParams={$container:_$addressGoogleMap,latitude:_latitudeLongitude.lat(),longitude:_latitudeLongitude.lng(),width:_staticGoogleMapWidth,height:_staticGoogleMapHeight,zoom:_googleMapsZoom,markers:markers,callback:function(data){data.errorMessage&&_showErrorMessage(data.errorMessage),skipLoading.showLoading(!1),_$addressGoogleMapContainer.removeClass("hidden"),navDropdowns.updateDropdownMenuHeight(),params.callback&&params.callback()}};googleMap.loadStaticGoogleMaps(staticMapParams)}function _generateMap(params){var mapParams={$container:_$addressGoogleMap,zoom:_googleMapsZoom};_addressMap=googleMap.initializeGoogleMaps(mapParams),_addressMap.setCenter(_latitudeLongitude),params.callback&&params.callback(),window.google.maps.event.addListenerOnce(_addressMap,"idle",function(){skipLoading.showLoading(!1),_$addressGoogleMap.css("background-image","none")}),window.google.maps.event.addListener(_addressMap,"dragstart",function(){_dragInProcess=!0}),window.google.maps.event.addListener(_addressMap,"dragend",function(){_dragInProcess=!1,_startTimerForChangeAddressAccordingToNewPinPosition()}),window.google.maps.event.addListener(_addressMap,"idle",function(){_dragInProcess||_startTimerForChangeAddressAccordingToNewPinPosition()}),window.google.maps.event.addListener(_addressMap,"zoom_changed",function(){_addressMap.setCenter(_latitudeLongitudeForMap)}),$(window).resize(function(){var newWindowWidth=$(window).width();newWindowWidth!==_windowWidth&&(_windowWidth=newWindowWidth,window.google.maps.event.addListenerOnce(_addressMap,"idle",function(){_addressMap.setCenter(_latitudeLongitudeForMap)}))})}function _loadMap(params){return _latitudeLongitude?(params=params?params:{},_highlightAddress(!1),void(_googleMapsStaticMaps?_generateStaticMap(params):_addressMap?(_addressMap.setCenter(_latitudeLongitude),params.callback&&params.callback()):_generateMap(params))):void _highlightAddress(!0)}function _determineAccuracy(googleAddress,typedAddress){var addressComponents=googleAddress.address_components,streetNumber=_extractStreetNumber(addressComponents).trim(),route=_extractRoute(addressComponents).trim(),postal=_verifyPostalCode(_extractPostalCode(addressComponents)),cleanAddress="",prefix="",accuracy=INACCURATE;return streetNumber.length>0?(accuracy=ACCURATE,typedAddress.indexOf(postal)>0&&(typedAddress=typedAddress.replace(postal,"")),cleanAddress=getAddressWithoutPrefix(typedAddress),prefix=typedAddress.replace(cleanAddress,"").replace(" ",""),cleanAddress.indexOf(streetNumber)==-1&&(prefix=prefix.replace(streetNumber,"")),prefix.length>0&&(accuracy=UNSURE),"GEOMETRIC_CENTER"!=googleAddress.geometry.location_type&&"RANGE_INTERPOLATED"!=googleAddress.geometry.location_type||(accuracy=UNSURE)):(accuracy=INACCURATE,typedAddress.indexOf(route)>0&&(accuracy=UNSURE)),accuracy}function _populateAddressObject(googleAddress,typedAddress){return{street_number:_extractStreetNumber(googleAddress.address_components),address:typedAddress,city:_extractCity(googleAddress.address_components,typedAddress),latitude:googleAddress.geometry.location.lat(),longitude:googleAddress.geometry.location.lng(),google_street_address:_extractStreetAddress(googleAddress.address_components),google_postal_code:_verifyPostalCode(_extractPostalCode(googleAddress.address_components)),province:_extractProvince(googleAddress.address_components),accuracy:_determineAccuracy(googleAddress,typedAddress)}}function _extractFromAddress(components,type){if(components)for(var i=0;i<components.length;i++)for(var j=0;j<components[i].types.length;j++)if(components[i].types[j]==type)return components[i].long_name;return""}function _extractCity(addressComponents,typedAddress){return _extractFromAddress(addressComponents,"locality")||_extractFromAddress(addressComponents,"sublocality")||_extractCityFromTypedAddress(typedAddress)}function _extractCityFromTypedAddress(typedAddress){var split=typedAddress.split(", ");if(split&&split.length>=3)return split[split.length-3]}function _extractProvince(addressComponents){return _extractFromAddress(addressComponents,"administrative_area_level_1")}function _extractPostalCode(addressComponents){return _extractFromAddress(addressComponents,"postal_code")}function _verifyPostalCode(postalCode){var canadaPostalCode="[a-zA-Z][0-9][a-zA-Z]( )?[0-9][a-zA-Z][0-9]",usPostalCode="[0-9]{5}(-[0-9]{4})?",validPostalCodeRegex=new RegExp("(^"+canadaPostalCode+"$)|(^"+usPostalCode+"$)"),matchPostalCodeRegex=new RegExp("("+canadaPostalCode+")|("+usPostalCode+")");if(!validPostalCodeRegex.test(postalCode)){var validPostalCode=postalCode.match(matchPostalCodeRegex);return validPostalCode?validPostalCode[0]:postalCode.trim().replace(/[ ]{2,}/g," ").replace(/[^a-zA-Z0-9- ]/g,"").slice(0,15)}return postalCode}function _extractStreetNumber(addressComponents){var streetNumber=_extractFromAddress(addressComponents,"street_number"),address="";return streetNumber&&(address+=streetNumber+" "),address}function _extractStreetAddress(addressComponents){var premise=_extractFromAddress(addressComponents,"premise"),streetNumber=_extractFromAddress(addressComponents,"street_number"),route=_extractFromAddress(addressComponents,"route"),address="";return!premise||streetNumber||route?(streetNumber&&(address+=streetNumber+" "),route&&(address+=route)):address=premise,address}function _extractRoute(addressComponents){var route=_extractFromAddress(addressComponents,"route"),address="";return route&&(address+=route),address}function _populateAddressFields(addressObject){for(var property in addressObject)addressObject.hasOwnProperty(property)&&_$addressFormAdd.find('input[name="'+property+'"]').val(addressObject[""+property])}function _populateAndLoadMap(address){if(skipAlerts.clearTopAlerts(),address.formatted_address){clearTimeout(_geocoderRequestTimeout);var addressObject=_populateAddressObject(address,_$addressAutocomplete.val());_checkAddressObjectContainsCity(addressObject)&&(_populateAddressFields(addressObject),_checkAddressObjectContainsCoordinates(addressObject)&&(_$orderTypeButton.length&&!_$orderTypeButton.hasClass("active")?skipLoading.showLoading(!1):_loadMapForAddress(addressObject)))}else _showErrorMessage("Unable to find an address. Please try again."),skipLoading.showLoading(!1),_highlightAddress(!0)}function _loadMapForAddress(addressObject){var addressLatLng=new window.google.maps.LatLng(addressObject.latitude,addressObject.longitude);_latitudeLongitude&&_latitudeLongitude.equals(addressLatLng)?_latitudeLongitude&&_latitudeLongitude.equals(addressLatLng)?(skipLoading.showLoading(!1),_expandGoogleMap()):skipLoading.showLoading(!1):(_latitudeLongitude=new window.google.maps.LatLng(addressObject.latitude,addressObject.longitude),_latitudeLongitudeForMap=_latitudeLongitude,_setDisableReverseGeocodingArea(addressObject),_resetAddressSelectWidgetToInitialAddress(),addressObject.address_id&&_$addressDraggableBtn.addClass("hidden"),_loadMap({callback:function(){_expandGoogleMap(),_validateAddress(addressObject),skipLoading.showLoading(!1)}}))}function _expandGoogleMap(){_$addressGoogleMapHeader.slideUp(),_$addressGoogleMapContainer.slideDown()}function _hideGoogleMap(){_$addressGoogleMapHeader.slideDown(),_$addressGoogleMapContainer.slideUp()}function _initGoogleAddressAutocomplete(){if(!_autocompleteService){if(!window.google)return;if(_currentlyLoadingGoogleMaps)return;_currentlyLoadingGoogleMaps=!0,_autocompleteService=geoService?geoService.AutocompleteService():new window.google.maps.places.AutocompleteService}}function _runWhenGoogleMapsAvailable(callbackFunction){_googleMapsIsAvailable?callbackFunction():_googleMapFns.push(callbackFunction)}function _handleGeolocationQuery(position){if(_activeGeolocationRequest=!1,clearTimeout(_skipLoadingForGeoRequest),_addressMap||skipLoading.showLoading(!0),position){var latitude=position.coords.latitude,longitude=position.coords.longitude,_geocoder=_geocoder||new window.google.maps.Geocoder,searchLocation=new window.google.maps.LatLng(latitude,longitude);_geocoder.geocode({latLng:searchLocation},function(results,status){if(status==OK)if(results[0]){var address=results[0];_$addressAutocomplete.val(address.formatted_address),_addressAutocompleteInputValue=address.formatted_address,_$addressFormAdd.find("input[name=address]").val(_$addressFormAdd.find("input[name=address]").val()),_resetAddressSelectWidgetToInitialAddress(),_hideAddressError(),_populateAndLoadMap(address),_clearSuggestions()}else _showErrorMessage("Sorry, we could find no addresses. Please enter your address manually."),skipLoading.showLoading(!1);else _showErrorMessage("Sorry, we could find no addresses. Please enter your address manually."),skipLoading.showLoading(!1)})}}function _handleGeolocationError(error){if(_activeGeolocationRequest){_activeGeolocationRequest=!1,clearTimeout(_skipLoadingForGeoRequest);var errorMessage="";errorMessage=error.code==error.PERMISSION_DENIED?"The locator was denied permission to find you. Please enter your address manually.":"The locator encountered an error. Please enter your address manually.",_$addressAutocomplete.one("click",function(){_hideAddressError()}),_showErrorMessage(errorMessage),skipLoading.showLoading(!1)}}function _updateSuggestions(address,prefix){var boundsObj=commonTools.northAmericaBounds(),southWest=new google.maps.LatLng(boundsObj.southWestLat,boundsObj.southWestLng),northEast=new google.maps.LatLng(boundsObj.northEastLat,boundsObj.northEastLng),bounds=new google.maps.LatLngBounds(southWest,northEast);_autocompleteService&&_autocompleteService.getPlacePredictions({input:address,types:["geocode"],bounds:bounds},function(predictions,status){if(status==OK)_renderSuggestions(predictions,prefix);else{var addressBase=getAddressWithoutPrefix(address);address!=addressBase?(prefix=address.replace(addressBase,""),_updateSuggestions(addressBase,prefix)):(_hideSuggestions(),_clearSuggestions(),_showErrorMessage(NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS))}})}function _renderSuggestions(predictions,prefix){prefix=prefix?prefix:"",_clearSuggestions(),predictions.forEach(function(prediction){$('<li><a href="javascript:void(0);" tabindex="-1">'+prefix+prediction.description+"</a></li>").appendTo(_$suggestions)}),_showSuggestions()}function _hideSuggestions(){_$suggestionsContainer.removeClass("open")}function _showSuggestions(){_$suggestions.children()[0]&&_$suggestionsContainer.addClass("open")}function _clearSuggestions(){_$suggestions.empty()}function _selectSuggestion(params){var $suggestion=params.$suggestion;if($suggestion){var newAddressAutocompleteInputValue=$suggestion.text();$suggestion.addClass("selected").siblings("li").removeClass("selected"),_$addressAutocomplete.val(newAddressAutocompleteInputValue),_addressAutocompleteInputValue=newAddressAutocompleteInputValue}}function _navigateSuggestions(params){var keyCode=params.keyCode,$listItems=_$suggestions.children();if(keyCode&&$listItems[0]){var $suggestionToSelect,$selectedSuggestion=$listItems.filter(".selected").first(),up=keyCode==KEYCODES.UP;$suggestionToSelect=$selectedSuggestion[0]?$selectedSuggestion.is(up?":first-child":":last-child")?up?$listItems.last():$listItems.first():up?$selectedSuggestion.prev():$selectedSuggestion.next():up?$listItems.last():$listItems.first(),_selectSuggestion({$suggestion:$suggestionToSelect})}}function _filterUserInput(input){return input.replace(/[^a-z0-9\xBF-\xFF \-#,;.:()'+&]/gi,"")}function _handleAddressAutocompleteChange(params){var address=params.address;if(skipLoading.showLoading(!0),_resetAddressSelectWidgetToInitialAddress(),_hideAddressError(),address){var _geocoder=_geocoder||new window.google.maps.Geocoder;_geocoder.geocode({address:address},function(results,status){status===OK?results[0]?_populateAndLoadMap(results[0]):(_showAddressError(NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS),skipLoading.showLoading(!1),skipLogging.error("Google place predictions found an address but geocoder failed due to: "+status+" address: "+address)):(_showAddressError(NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS),skipLoading.showLoading(!1),skipLogging.error("_handleAddressAutocompleteChange: Google geocoder failed due to: "+status+" address: "+address))}),_hideSuggestions(),_clearSuggestions()}else _showErrorMessage(params.errorMessage),skipLoading.showLoading(!1)}function _setPlaceholderTextOfAddressAutocomplete(){parseInt(_$addressAutocomplete.width())<300?_$addressAutocomplete.prop("placeholder","Enter Your Address"):_$addressAutocomplete.prop("placeholder","Get Started by Entering Your Address")}function getAddressWithoutPrefix(address){var separator=/(\d+\w?[- ]+)(\d+.*)/,addressArray=address.split(separator);return addressArray.length>2?getAddressWithoutPrefix(addressArray[2]):address}function _checkAddressObjectContainsCity(addressObject){return!(!addressObject||!addressObject.city)||(_showErrorMessage("Unable to determine the city of this location. Please try again."),skipLoading.showLoading(!1),_highlightAddress(!0),!1)}function _checkAddressObjectContainsCoordinates(addressObject){return!!(addressObject&&addressObject.latitude&&addressObject.longitude)||(_showErrorMessage("Unable to determine coordinates of location. Please try again."),skipLoading.showLoading(!1),_highlightAddress(!0),!1)}function _loadAddressObjectFromForm(){var addressObject={street_number:_$addressFormAdd.find("input[name=street_number]").val(),address:_$addressFormAdd.find("input[name=address]").val(),address_id:_$addressFormAdd.find("input[name=address_id]").val(),city:_$addressFormAdd.find("input[name=city]").val(),latitude:_$addressFormAdd.find("input[name=latitude]").val(),longitude:_$addressFormAdd.find("input[name=longitude]").val(),google_street_address:_$addressFormAdd.find("input[name=google_street_address]").val(),google_postal_code:_$addressFormAdd.find("input[name=google_postal_code]").val(),province:_$addressFormAdd.find("input[name=province]").val(),accuracy:_$addressFormAdd.find("input[name=accuracy]").val(),order_type:_$addressFormAdd.find("input[name=order_type]").val()};return addressObject}var _addressMap,_$geolocationButton,_latitudeLongitude,_latitudeLongitudeForMap,_$addressAutocomplete,_$addressFormAdd,_$addressGoogleMap,_$addressGoogleMapContainer,_$addressGoogleMapHeader,_$addressErrorBlock,_addressLatitudeCorrected,_addressLongitudeCorrected,_$addressDraggableBtn,_$addressResetBtn,_$addressAddBtn,_newAddress,_geocoderRequestTimeout,_disableReverseGeocodingRadius,_$addressSubmitBtn,_staticGoogleMapWidth,_staticGoogleMapHeight,_googleMapsZoom,_allowAllAddresses,_markers,_skipLoadingForGeoRequest,_activeGeolocationRequest,_userLoggedIn,_$userAddressesSelect,_$orderTypeButton,_autocompleteService,_$suggestionsContainer,_$suggestions,_minSearchCharacters,_addressAutocompleteInputValue,_addressAutocompleteMousedownTimer,_addressAutocompleteKeyupInterval,_addressAutocompleteKeyupResetTimer,_$addressMapAddNew,_windowWidth,DANGER="danger",WARNING="warning",INACCURATE="INACCURATE",ACCURATE="ACCURATE",UNSURE="UNSURE",DISABLE_REVERSE_GEOCODING_RADIUS_SPECIFIC_BUILDING=0,DISABLE_REVERSE_GEOCODING_RADIUS_RANGE_OF_BUILDINGS=500,NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_PIN="No results found. Try resetting the pin.",NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS='No results found. Please try again or use the <i class="ion-icon ion-android-locate"></i> button and drag the pin to your location.',SELECT_FROM_DROPDOWN_ERROR_MESSAGE="Please choose an address from one of the dropdown results.",OK="OK",GEOLOCATION_TIMEOUT=1e4,GEOLOCATION_TIMEOUT_FALLBACK=1e4,GEOLOCATION_CACHED_MAXIMUM_AGE=3e5,KEYCODES={TAB:9,ENTER:13,UP:38,DOWN:40},_googleMapsStaticMaps=!0,_googleMapsIsAvailable=!1,_currentlyLoadingGoogleMaps=!1,_googleMapFns=[],_dragInProcess=!1;return{init:function(params){$(document).ready(function(){_$addressGoogleMap=$(params.googleMapSelector),_$addressGoogleMapContainer=$(params.googleMapContainerSelector),_$addressGoogleMapHeader=$(params.googleMapHeaderSelector),_$addressFormAdd=$(params.addressFormAddSelector),_$addressAutocomplete=$(params.addressAutocompleteSelector),_$addressErrorBlock=$(params.addressErrorSelector),_$geolocationButton=$(params.geolocationButtonSelector),_$addressDraggableBtn=$(params.addressDraggableBtnSelector),_$addressResetBtn=$(params.addressResetBtnSelector),_$addressAddBtn=$(params.addressAddBtnSelector),_$addressSubmitBtn=$(params.addressSubmitBtnSelector),_staticGoogleMapWidth=params.staticGoogleMapWidth,_staticGoogleMapHeight=params.staticGoogleMapHeight,_googleMapsZoom=params.googleMapsZoom,_markers=params.markers,_allowAllAddresses=params.allowAllAddresses||!1,_userLoggedIn=params.user,_$userAddressesSelect=$(params.userAddressesSelectSelector),_$orderTypeButton=$(params.orderTypeButtonSelector),_$suggestions=$(params.suggestionsSelector),_$suggestionsContainer=_$suggestions.parent(),_minSearchCharacters=params.minSearchCharacters||3,_addressAutocompleteInputValue="",_$addressMapAddNew=$(params.addressMapAddNewSelector),_windowWidth=$(window).width();var autofocusAutocomplete=params.autofocusAutocomplete;$(params.addressClearBtnSelector).click(function(){_hideGoogleMap(),_$addressAutocomplete.val("").focus(),_latitudeLongitude=""}),_runWhenGoogleMapsAvailable(function(){OK=window.google.maps.places.PlacesServiceStatus.OK}),_setPlaceholderTextOfAddressAutocomplete();var userOpenThisPageByPressBackButton=!1,userWentToPreviousPageAfterAJAXCall=!1;if(window.performance&&window.performance.navigation&&window.performance.navigation.type&&2==window.performance.navigation.type&&(userOpenThisPageByPressBackButton=!0),_$addressFormAdd.find("input[name=ajax_call]").val()&&(userWentToPreviousPageAfterAJAXCall=!0),userOpenThisPageByPressBackButton&&userWentToPreviousPageAfterAJAXCall){var defaultAddressId=_$addressFormAdd.find("input[name=address_id]").val(),defaultLatitude=_$addressFormAdd.find("input[name=latitude]").val(),defaultLongitude=_$addressFormAdd.find("input[name=longitude]").val();skipLoading.showLoading(!0),_runWhenGoogleMapsAvailable(function(){var _geocoder=_geocoder||new window.google.maps.Geocoder,searchLocation=new window.google.maps.LatLng(defaultLatitude,defaultLongitude);_geocoder.geocode({latLng:searchLocation},function(results,status){if(status===OK)if(results[0]){var addressObject=results[0],addressObject_real=_populateAddressObject(results[0],results[0].formatted_address);_validateAddress(addressObject_real),addressObject.address=_$addressFormAdd.find("input[name=address]").val(),addressObject.address_id=defaultAddressId,addressObject.latitude=defaultLatitude,addressObject.longitude=defaultLongitude,_$addressAutocomplete.val(addressObject.address),_addressAutocompleteInputValue=addressObject.address,_$orderTypeButton.removeClass("active"),$("#btn-"+_$addressFormAdd.find("input[name=order_type]").val()).addClass("active"),_populateAddressFields(addressObject),_loadMapForAddress(addressObject)}else _showAddressError(NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS),skipLoading.showLoading(!1);else _showAddressError(NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS),skipLoading.showLoading(!1),skipLogging.error("_runWhenGoogleMapsAvailable: Google geocoder failed due to: "+status+" latLng: "+searchLocation)}),_$addressFormAdd.find("input[name=ajax_call]").val("")}),_loadGoogleMaps()}params.defaultAddress&&(autofocusAutocomplete=!1,_runWhenGoogleMapsAvailable(function(){_autocompleteService||_runWhenGoogleMapsAvailable(function(){_initGoogleAddressAutocomplete()})}),_loadGoogleMaps(),_addressAutocompleteInputValue=_$addressAutocomplete.val()),autofocusAutocomplete&&_$addressAutocomplete.focus(),window.screen.deviceXDPI&&(window.devicePixelRatio=parseInt(window.screen.deviceXDPI/window.screen.logicalXDPI));var icon_key=window.devicePixelRatio>=2?"customer_retina":"customer";$(params.addressMarkerSelector).css("background-image","url("+_markers[icon_key]+")"),navigator.geolocation?_$geolocationButton.click(function(){_addressMap||skipLoading.showLoading(!0);var geoOptions={enableHighAccuracy:!1,timeout:GEOLOCATION_TIMEOUT,maximumAge:GEOLOCATION_CACHED_MAXIMUM_AGE};_runWhenGoogleMapsAvailable(function(){_skipLoadingForGeoRequest=setTimeout(function(){skipLoading.showLoading(!1)},GEOLOCATION_TIMEOUT_FALLBACK),_activeGeolocationRequest=!0,navigator.geolocation.getCurrentPosition(_handleGeolocationQuery,_handleGeolocationError,geoOptions)}),_loadGoogleMaps()}):_$geolocationButton.addClass("hidden"),_$addressAutocomplete.on("keydown",function(e){switch(e.which){case KEYCODES.ENTER:case KEYCODES.UP:case KEYCODES.DOWN:e.preventDefault();break;case KEYCODES.TAB:_hideSuggestions()}}),_$addressAutocomplete.on("keyup cut copy paste",function(e,data){var keyCode=data&&data.keyCode?data.keyCode:e.which;switch(keyCode){case KEYCODES.UP:case KEYCODES.DOWN:_navigateSuggestions({keyCode:keyCode});break;case KEYCODES.ENTER:var newAddressAutocompleteInputValue,errorMessage,$selectedListItem=_$suggestions.children().filter(".selected").first();$selectedListItem[0]?(newAddressAutocompleteInputValue=$selectedListItem.text(),errorMessage=NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS,_addressAutocompleteInputValue=newAddressAutocompleteInputValue):(newAddressAutocompleteInputValue=_$addressAutocomplete.val(),_addressAutocompleteInputValue!=newAddressAutocompleteInputValue&&(errorMessage=_$suggestions.filter(":visible").children()[0]?SELECT_FROM_DROPDOWN_ERROR_MESSAGE:NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS)),errorMessage&&_handleAddressAutocompleteChange({address:$selectedListItem.text(),errorMessage:errorMessage});break;case KEYCODES.TAB:break;default:_googleMapsIsAvailable||_loadGoogleMaps(),_autocompleteService||_runWhenGoogleMapsAvailable(function(){_initGoogleAddressAutocomplete()});var input=this;clearInterval(_addressAutocompleteKeyupInterval),clearTimeout(_addressAutocompleteKeyupResetTimer),_addressAutocompleteKeyupInterval=setInterval(function(){var newAddressAutocompleteInputValue=_filterUserInput(_$addressAutocomplete.val()),start=input.selectionStart,end=input.selectionEnd;newAddressAutocompleteInputValue.length<_minSearchCharacters?(clearTimeout(_addressAutocompleteKeyupResetTimer),clearInterval(_addressAutocompleteKeyupInterval),_hideSuggestions(),_clearSuggestions(),_$addressAutocomplete.val(newAddressAutocompleteInputValue),_addressAutocompleteInputValue=newAddressAutocompleteInputValue,input.setSelectionRange(start,end)):_addressAutocompleteInputValue!=newAddressAutocompleteInputValue&&(clearTimeout(_addressAutocompleteKeyupResetTimer),clearInterval(_addressAutocompleteKeyupInterval),_runWhenGoogleMapsAvailable(function(){_updateSuggestions(_$addressAutocomplete.val())}),_$addressAutocomplete.is(":focus")?_$addressAutocomplete.val(newAddressAutocompleteInputValue):_runWhenGoogleMapsAvailable(function(){newAddressAutocompleteInputValue=newAddressAutocompleteInputValue.split(",")[0],_$addressAutocomplete.val(newAddressAutocompleteInputValue).focus().trigger("keyup",{keyCode:KEYCODES.ENTER})}),_addressAutocompleteInputValue=newAddressAutocompleteInputValue,input.setSelectionRange(start,end))},70),_addressAutocompleteKeyupResetTimer=setTimeout(function(){clearInterval(_addressAutocompleteKeyupInterval)},700)}}),_$addressAutocomplete.on("mousedown",function(e){if(e.stopPropagation(),_$addressAutocomplete.val().length>=_minSearchCharacters&&_$suggestions.children()[0]){var hidSuggestions=!1,handler=function(e){e.preventDefault(),hidSuggestions=!0,_showSuggestions(),_$suggestionsContainer.off("hide.bs.dropdown",handler),e.stopPropagation()};_$suggestionsContainer.one("hide.bs.dropdown",handler),clearTimeout(_addressAutocompleteMousedownTimer),_addressAutocompleteMousedownTimer=setTimeout(function(){hidSuggestions||(_$suggestionsContainer.off("hide.bs.dropdown",handler),_showSuggestions())},250)}}),_$addressAutocomplete.on("focus",_showSuggestions),_$suggestionsContainer.on("hide.bs.dropdown",function(e){e.preventDefault(),_hideSuggestions()}),_$suggestionsContainer.parents(".dropdown-menu").on("mousedown",function(e){_hideSuggestions()}),_$suggestions.on("mousedown","a",function(e){e.stopPropagation()}),_$suggestions.on("mouseup","a",function(){var $this=$(this),newAddressAutocompleteInputValue=$this.text();_handleAddressAutocompleteChange({address:$this.parent().text(),errorMessage:NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS}),_$addressAutocomplete.val(newAddressAutocompleteInputValue),_addressAutocompleteInputValue=newAddressAutocompleteInputValue}),_$addressDraggableBtn.click(function(){$(this).addClass("hidden"),_$addressResetBtn.removeClass("hidden"),_googleMapsStaticMaps=!1,_addressMap?(_addressMap.set("draggable",!0),_addressMap.set("scrollwheel",!0),_addressMap.set("disableDoubleClickZoom",!1),_addressMap.set("keyboardShortcuts",!0)):(skipLoading.showLoading(!0),_loadMap())}),_$addressResetBtn.click(function(){_hideAddressError(),_resetAddressSelectWidgetToInitialAddress(),_addressMap&&_addressMap.setCenter(_latitudeLongitude),_latitudeLongitudeForMap=_latitudeLongitude,clearTimeout(_geocoderRequestTimeout),_$addressAutocomplete.val(_$addressFormAdd.find('input[name="address"]').val())}),_$addressAddBtn.click(function(event){if(event.preventDefault(),_newAddress){var addressObject_real=_populateAddressObject(_newAddress,_newAddress.formatted_address);if(!_validateAddress(addressObject_real))return;_populateAndLoadMap(_newAddress),_resetAddressSelectWidgetToInitialAddress()}var addressObject={street_number:_$addressFormAdd.find("input[name=street_number]").val(),address:_$addressFormAdd.find("input[name=address]").val(),city:_$addressFormAdd.find("input[name=city]").val(),latitude:_$addressFormAdd.find("input[name=latitude]").val(),longitude:_$addressFormAdd.find("input[name=longitude]").val(),google_street_address:_$addressFormAdd.find("input[name=google_street_address]").val(),google_postal_code:_$addressFormAdd.find("input[name=google_postal_code]").val(),province:_$addressFormAdd.find("input[name=province]").val(),accuracy:_$addressFormAdd.find("input[name=accuracy]").val(),order_type:_$addressFormAdd.find("input[name=order_type]").val()};if(_addressLatitudeCorrected&&_addressLongitudeCorrected&&(addressObject.latitude=_addressLatitudeCorrected.toString(),addressObject.longitude=_addressLongitudeCorrected.toString(),addressObject.accuracy==ACCURATE&&(addressObject.accuracy=UNSURE)),_$addressFormAdd.find("input[name=address_id]").val()&&(addressObject.address_id=_$addressFormAdd.find("input[name=address_id]").val()),!addressObject.address_id&&_$addressAutocomplete.val()!=_$addressFormAdd.find("input[name=address]").val())return _showErrorMessage(_$suggestions.filter(":visible").children()[0]?SELECT_FROM_DROPDOWN_ERROR_MESSAGE:NO_ADDRESSES_FOUND_ERROR_MESSAGE_RESET_ADDRESS),void skipLoading.showLoading(!1);if(_validateAddress(addressObject)){var ajaxUrl,ajaxAddAddressUrl=$(this).data("url-add"),ajaxUpdateSessionUrl=$(this).data("url-update");skipLoading.showLoading(!0),ajaxUrl=_userLoggedIn&&!addressObject.address_id?ajaxAddAddressUrl:ajaxUpdateSessionUrl,$.post(ajaxUrl,addressObject,function(data){if(data.errorMessage)_showErrorMessage(data.errorMessage),skipLoading.showLoading(!1);else if(_$addressFormAdd.find("input[name=ajax_call]").val("true"),window.location.href.indexOf("restaurants")!==-1||"/"==window.location.pathname){var city=data.city.replace(" ","-").toLowerCase();window.location.href="/"+city+"/restaurants"}else window.location.href=window.location.href}).fail(function(){skipAlerts.showTopAlert(DANGER,"There was an unexpected problem adding the address."),skipLoading.showLoading(!1)})}}),$(window).on("resize",function(){var newWindowWidth=$(window).width();newWindowWidth!==_windowWidth&&(_windowWidth=newWindowWidth,_setPlaceholderTextOfAddressAutocomplete())})})},handleGoogleMapsInit:function(){_googleMapsIsAvailable=!0,_currentlyLoadingGoogleMaps=!1;var length=_googleMapFns.length;if(length>0)for(var index=0;index<length;index++)_googleMapFns[index]&&(_googleMapFns[index](),_googleMapFns[index]=null)},runWhenGoogleMapsAvailable:function(callback){_runWhenGoogleMapsAvailable(callback)},loadMapForAddress:function(addressObject){_runWhenGoogleMapsAvailable(function(){_loadMapForAddress(addressObject);
}),_loadGoogleMaps()},populateAddressFields:function(addressObject){_populateAddressFields(addressObject)},autocompletePlaceholderTextChange:function(){_setPlaceholderTextOfAddressAutocomplete()},clearMap:function(){_$addressResetBtn.click(),_hideGoogleMap()},orderTypeSelected:function(){var addressObject={};_$userAddressesSelect.length&&!_$userAddressesSelect.is(":hidden")?""!=_$userAddressesSelect.val()?(addressObject={street_number:_$addressFormAdd.find("input[name=street_number]").val(),address:_$addressFormAdd.find("input[name=address]").val(),address_id:_$addressFormAdd.find("input[name=address_id]").val(),city:_$addressFormAdd.find("input[name=city]").val(),latitude:_$addressFormAdd.find("input[name=latitude]").val(),longitude:_$addressFormAdd.find("input[name=longitude]").val(),google_street_address:_$addressFormAdd.find("input[name=google_street_address]").val(),google_postal_code:_$addressFormAdd.find("input[name=google_postal_code]").val(),province:_$addressFormAdd.find("input[name=province]").val(),accuracy:_$addressFormAdd.find("input[name=accuracy]").val(),order_type:_$addressFormAdd.find("input[name=order_type]").val()},_loadMapForAddress(addressObject)):_highlightAddress(!0):_$addressFormAdd.find("input[name=address_display]").val().length?(addressObject={street_number:_$addressFormAdd.find("input[name=street_number]").val(),address:_$addressFormAdd.find("input[name=address]").val(),city:_$addressFormAdd.find("input[name=city]").val(),latitude:_$addressFormAdd.find("input[name=latitude]").val(),longitude:_$addressFormAdd.find("input[name=longitude]").val(),google_street_address:_$addressFormAdd.find("input[name=google_street_address]").val(),google_postal_code:_$addressFormAdd.find("input[name=google_postal_code]").val(),province:_$addressFormAdd.find("input[name=province]").val(),accuracy:_$addressFormAdd.find("input[name=accuracy]").val(),order_type:_$addressFormAdd.find("input[name=order_type]").val()},_addressAutocompleteInputValue=addressObject.address,_loadMapForAddress(addressObject)):_highlightAddress(!0)}}}(jQuery,window.skipthedishes.Loading,window.skipthedishes.Alerts,window.skipthedishes.Logging,window.skipthedishes.NavDropdowns,window.skipthedishes.GoogleMap,window.skipthedishes.CommonTools,window.skipthedishes.GeoService);